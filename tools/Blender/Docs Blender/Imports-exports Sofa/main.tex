%------------------------------------------------------------------------------
% En-tête du document
%------------------------------------------------------------------------------
\documentclass[11pt, a4paper, oneside]{article}
\usepackage[latin1]{inputenc}
\usepackage[francais]{babel}

%\usepackage[toc]{multitoc}% table des matières sur 2 colonnes 

\usepackage{longtable}% pour longtable

% Symbole euro par \euro{}
\usepackage{eurosym}

% Utilisation des mathématiques
\usepackage{amsmath}% permet l'utilisation de \boxed
\usepackage{amsfonts}
\usepackage{amssymb}

% Création d'un index  (puis ajouter \index{bla} et \printindex
\usepackage{makeidx}
\usepackage{tocbibind} 
\makeindex

% mise en page
\usepackage[headheight=1.2cm, top=1.5cm, bottom=1.5cm, left=2.0cm, right=1.5cm, dvips]{geometry}
%\usepackage{indentfirst}
\setlength{\parindent}{0pt}% supprime l'indentation

% Helvética
\renewcommand\familydefault{\sfdefault}
\usepackage{helvet}

% en-têtes et pieds de page
\usepackage{fancyhdr}
\usepackage{lastpage}
%\lhead{}
\chead{}
\rhead{}
\renewcommand{\headrulewidth}{0.1pt}
\renewcommand{\footrulewidth}{0.1pt}
%\lfoot{}
\cfoot{}
\rfoot{page \thepage \,\,/ \pageref{LastPage}}

\pagestyle{fancy}


% Redéfinition pour les formules de maths
\newcommand{\ds}{\displaystyle}
\newcommand{\ora}{\overrightarrow}

% Colonnes (utilisation par %\begin{multicols}{2} )
\usepackage{multicol} %permet d'utiliser le mode multicolonnes  \columnbreak% Autre colonne
\setlength{\columnseprule}{0.5pt} % trace les lignes verticales entre les colonnes
\setlength{\columnsep}{30pt}% distance entre les colonnes

% Soulignements
\usepackage{ulem}% pour pouvoir utiliser \uline{texte à souligner} intervient sur \emph{txt en valeur}

% Espacement des paragraphes
\setlength{\parskip}{0.5\baselineskip}

% Liens
\usepackage[colorlinks, linkcolor=blue]{hyperref}

% Insertion d'images avec \includegraphics[width=3cm]{Icone.png}
\usepackage{graphicx}

% Utilisation de PStricks (graphiques)
\usepackage{pstricks}


% Insertion d'images avec \parpic
\usepackage{picins}

% Ecriture de code
\usepackage{listings}
\usepackage{color} % on en a besoin pour utiliser les couleurs


%\newenvironment{keywords}{
%\list{}{\advance\topsep by0.35cm\relax\small
%				\leftmargin=1cm
%				\labelwidth=0.35cm
%				\listparindent=0.35cm
%				\itemindent\listparindent
%				\rightmargin\leftmargin}\item[\hskip\labelsep
%        					                     \bfseries Mot-clefs:]}
%{\endlist}
     

%------------------------------------------------------------------------------
% Début du document
%------------------------------------------------------------------------------
\begin{document}

\makeatletter % enlève les pieds de page dans les chapitres
   \let \ps@plain=\ps@empty
\makeatother 

\title{Utilisation des imports-exports SOFA avec Blender}
\author{Vincent Vansuyt}
\date{24 septembre 2008}

\maketitle

\tableofcontents

%\lstset{language=Matlab}
\lstset{language=C++}
\lstset{tabsize=2}
\definecolor{clFond}{rgb}{0.97,0.97,0.97} 
\definecolor{clCommentaires}{rgb}{0.0, 0.5, 0.0}
\definecolor{clMotsClef}{rgb}{0.0, 0.0, 0.5}
\lstset{
				backgroundcolor=\color{clFond},
				keywordstyle=\color{clMotsClef},
				commentstyle=\color{clCommentaires}, 
				extendedchars=true,
				showspaces=false,
				showstringspaces=false,
				showtabs=false,
				tab=\rightarrowfill,
				basicstyle=\small,
				breaklines=true, 
				frame=single,
				frameround=ttff,
				numberstyle=\tiny, 
				numbers=left,
				stepnumber=2, 
				numbersep=5pt, 
				framexleftmargin=-0.4mm, 
				tabsize=2, 
				xleftmargin=0mm,
				xrightmargin=0mm}

\pagebreak
\section{Introduction}

Ce document explique comment installer, configurer et utiliser les scripts Blender d'import-export des scènes SOFA.

\section{Version des logiciels utilisés}

Ces scripts ont été testé avec Blender v2.46 et v2.47, Windows XP et Linux Fedora.

\section{Installation}

Pour installer ces scripts, se reporter au document pdf de cette arborescence :\\
``\verb+../Installer_et_programmer_des_scripts_dans_Blender+".

\section{Configuration}

Les scripts d'import-export sont configurable grâce au fichier XML ``\verb+sofa\config.xml+" (voir listing \ref{lstConfig_xml}).

L'attribut ``strScenesPath" indique où sont rangées les fichiers scènes SOFA.

L'attribut ``strSofaPath" indique le chemin de base de SOFA.

L'attribut ``strNomCompletDerniereSceneImport" est mis à jour par les scripts Blender lors de l'ouverture de scènes SOFA.

L'attribut ``strNomCompletExecutableSofa" indique le nom complet de l'exécutable ``runSofa".


\lstset{language=XML}
\begin{lstlisting}[label=lstConfig_xml, caption = fichier ``config.xml"]
<?xml version="1.0" encoding="ISO-8859-1"?>
<Config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
	  <Path strScenesPath="/disc/bousquet/dev/Sofa/examples/Demos" strSofaPath="/disc/bousquet/dev/Sofa"/>  
	  <Files strNomCompletDerniereSceneImport="/disc/bousquet/dev/Sofa/examples/Demos" strNomCompletExecutableSofa="/disc/bousquet/dev/Sofa/bin/runSofa"/>  
  </Config>
\end{lstlisting}

\pagebreak
\section{Principe de fonctionnement}

Les scripts d'import-export des scènes SOFA pour Blender fonctionnent sur le principe décrit figure \ref{fig:Overview}.
\begin{minipage}{17.5cm}
	\centering
	\includegraphics[width=17.5cm]{Blender_overview/Overview}
	\caption{Principe de fonctionnement}
	\label{fig:Overview}
\end{minipage}


\section{Détail du logiciel ``Import - export des scènes SOFA avec Blender"}\label{lab_detail_blender_sofa}

\subsection{Script ``Import des scènes SOFA dans Blender"}

\subsubsection{Utilisation}

Voici la procédure à utiliser pour importer des scènes Blender dans SOFA :
\begin{enumerate}
	\item L'accès à la fonction d'import se fait par le menu de Blender ``File - Import" (voir figure \ref{fig:blender_import_scene_SOFA_01})
	\item Ensuite on sélectionne le fichier scène SOFA à importer (figure \ref{fig:blender_import_scene_SOFA_02})
	\item Après quelques secondes d'attente et rotation de la vue, on obtient le résultat 
\ref{fig:blender_import_scene_SOFA_03})	
\end{enumerate}

La figure \ref{fig:blender_import_scene_SOFA_04} représente le même fichier scène ouvert avec SOFA.

\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_import_scene_SOFA_01}
	\caption{Accès à la fonction d'import}
	\label{fig:blender_import_scene_SOFA_01}
\end{minipage}
\hfill
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_import_scene_SOFA_02}
	\caption{Choix de la scène à importer}
	\label{fig:blender_import_scene_SOFA_02}
\end{minipage}


\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_import_scene_SOFA_03}
	\caption{Résultat dans Blender (après orientation de la vue)}
	\label{fig:blender_import_scene_SOFA_03}
\end{minipage}
\hfill
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_import_scene_SOFA_04}
	\caption{Le résultat obtenu avec la même scène dans SOFA}
	\label{fig:blender_import_scene_SOFA_04}
\end{minipage}


A l'issue de cet import, on remarque que les noms des objets (voir figure \ref{fig:blender_nom_objet}) portent bien les mêmes noms que les noeuds du fichier XML SOFA importé. A ceci près que les noms des objets dans Blenders sont uniques. Si tous les maillons de la chaîne de la scène s'appellent ``Torus", dans Blender il seront appelés ``Torus", ``Torus.001", ``Torus.002", etc.

\begin{center}
\begin{minipage}{16cm}
	\centering
	\includegraphics[height=6cm]{Blender_tutoriels/blender_nom_objet}
	\caption{Nom de l'objet selectionné dans une fenêtre ``Button windows"}
	\label{fig:blender_nom_objet}
\end{minipage}
\end{center}


\subsubsection{Description de l'algorithme utilisé}\label{algo_import_scene_SOFA}

\begin{itemize}
	\item La fonction d'import parcourt l'arbre du fichier XML SOFA en profondeur (fonction ``importer" du fichier ``main\_CImport\_depuis\_SOFA.py"). 
	\begin{itemize}
		\item Si un noeud ``Node" de l'arbre contient un noeud enfant qui s'appelle ``Object" et qui a un attribut ``Type" de valeur ``MechanicalObject", alors
		\begin{itemize}
			\item La valeur de l'attribut ``name" du noeud ``Node" est mémorisée comme nom du nouvel objet à ajouter dans Blender (je stocke ce nom dans la variable ``\verb+strNomObjet+")
			\item La ``profondeur" où a été trouvée ce noeud est stockée dans la variable \verb+nNiveauTrouve+
			\item Tant que le parcours des noeuds ne descendra pas en dessous de la profondeur \verb+nNiveauTrouve+, tous les nouveaux noeuds parcourus serviront à collecter des informations pour l'objet\\ ``\verb+strNomObjet+" trouvé pour Blender
			\item La ``collecte des informations" se base sur les attributs 
				\begin{itemize}
					\item ``dx, dy, dz" et ``rx, ry, rz" pour les positions
					\item ``color" pour la couleur
					\item ``filename" pour le nom de fichier ``.obj". Par défaut, l'algorithme prend pour valeur de maillage le fichier spécifié par le premier ``filename" (en général, c'est le fichier visuel)
					\item (voir fonction ``def getInformations\_depuis\_noeud( self, noeud ):" du fichier ``sp\_Solide.py")					
				\end{itemize}
		\end{itemize}
	\end{itemize}
	\item Si le parcours arrive en dessous de la profondeur \verb+nNiveauTrouve+ ou que le parcours de l'arbre se termine, l'objet ``solide" renseigné est ajouté dans la scène courante de Blender (voir méthode ``def ajouter\_dans\_la\_scene( self, scene ):" du fichier ``sp\_Solide.py").
\end{itemize}


\pagebreak
\subsection{Script ``Export des scènes Blender vers SOFA"}

\subsubsection{Utilisation}

La fonction d'export de Blender vers SOFA exporte les positions, les couleurs et éventuellement (suivant les choix de l'utilisateur) les maillages de la scène.

Les conditions pour réussir un export sont les suivantes :
\begin{enumerate}
 \item le fichier de scène SOFA doit exister
 \item le nom des noeuds de l'arbre de scène XML SOFA et les noms des objets dans la scène Blender doivent correspondre (si les noms ne correspondent pas, les positions de la scène XML ne sont pas mises à jour)
\end{enumerate}

Si ces conditions sont réunies, voici la procédure à utiliser pour ``exporter" des scènes Blender dans SOFA :
\begin{enumerate}
	\item L'accès à la fonction d'export se fait par le menu de Blender ``File - Export" (voir figure \ref{fig:blender_export_scene_SOFA_02})
	\item Ensuite on sélectionne le fichier scène SOFA à importer (figure \ref{fig:blender_export_scene_SOFA_03})
	\item On peut alors sélectionner d'exporter les maillages des objets de la scène Blender comme mail\-lage de visualisation et / ou comme maillage de collision (voir figure  \ref{fig:blender_export_scene_SOFA_04})
	\item Si on ouvre la scène avec SOFA, on vérifie que les modifications on été prises en compte
\ref{fig:blender_export_scene_SOFA_05})	
\end{enumerate}

Les figures \ref{fig:blender_export_scene_SOFA_06} à \ref{fig:blender_export_scene_SOFA_12} présentent des exports de Blender vers une scène SOFA en choisissant d'autres options et d'autres modifications de la scène.


\begin{center}
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_01}
	\caption{Scène test dans Blender}
	\label{fig:blender_export_scene_SOFA_01}
\end{minipage}
\hfill
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_02}
	\caption{Appel de la fonction d'export par le menu ``File - export"}
	\label{fig:blender_export_scene_SOFA_02}
\end{minipage}
\end{center}

\begin{center}
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_03}
	\caption{Choix du fichier scène SOFA à mettre à jour}
	\label{fig:blender_export_scene_SOFA_03}
\end{minipage}
\hfill
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_04}
	\caption{Options à cocher pour indiquer si on veut mettre à jour les fichiers de maillage de la scène (le maillage de visualisation et le maillage de collision)}
	\label{fig:blender_export_scene_SOFA_04}
\end{minipage}
\end{center}

La fenêtre de dialogue figure \ref{fig:blender_export_scene_SOFA_04} correspond au code ci-apès (listing \ref{lst_choix_options_export}). On voit que le texte affiché est coupé pour l'instant (au 11 juin 2008). Une solution pour améliorer la lisibilité sera peut-être trouvée d'ici la fin du stage ...

\lstset{language=Python}
\begin{lstlisting}[label=lst_choix_options_export, caption = Code Python pour le choix des options d'export]
		# Récupération de réglages complémentaires
		EXPORT_FICHIERS_OBJ_VISU = Draw.Create(0)
		EXPORT_FICHIERS_OBJ_COLLISION = Draw.Create(0)
	
		# Récupération des options de l'utilisateur
		pup_block = []
		pup_block.append('Choix des informations à exporter :')		
		pup_block.append(('Maillages visualisation', EXPORT_FICHIERS_OBJ_VISU, 'Enregistrer les maillages dans le dossier de visualisation'));
		pup_block.append(('Maillages collision', EXPORT_FICHIERS_OBJ_COLLISION, 'Enregistrer les maillages dans le dossier de collision'));
		if not Draw.PupBlock('Choix des informations à exporter', pup_block):
			return
\end{lstlisting}

\begin{center}
\begin{minipage}{16cm}
	\centering
	\includegraphics[width=8cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_05}
	\caption{Scène dans SOFA après export Blender}
	\label{fig:blender_export_scene_SOFA_05}
\end{minipage}
\end{center}

Dans la figure \ref{fig:blender_export_scene_SOFA_05} on remarque des ombres qui suivent à peu près le maillage de l'objet. Cela vient du fait que la fonction d'export des maillages pour l'instant (au 11 juin 2008) n'exporte pas les normales dans le fichier .obj (seulement les faces et les sommets).

\begin{center}
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_06}
	\caption{Modification de la scène dans Blender (modification du maillage ``Cone", changement de sa couleur et des positions des autres objets}
	\label{fig:blender_export_scene_SOFA_06}
\end{minipage}
\hfill
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_07}
	\caption{Choix de ne mettre à jour que le maillage de collision lors de l'export}
	\label{fig:blender_export_scene_SOFA_07}
\end{minipage}
\end{center}


\begin{center}
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_08}
	\caption{Résultat dans SOFA, le modèle visuel ne correspondant pas au maillage du cone modifié}
	\label{fig:blender_export_scene_SOFA_08}
\end{minipage}
\hfill
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=7.5cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_09}
	\caption{Résultat dans SOFA, le modèle de collision correspond bien au maillage du cone modifié}
	\label{fig:blender_export_scene_SOFA_09}
\end{minipage}
\end{center}

\begin{center}
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=6cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_10}
	\caption{On exporte de nouveau la scène en cochant les deux boutons de mise à jour des maillages (visuel et collision)...}
	\label{fig:blender_export_scene_SOFA_10}
\end{minipage}
\hfill
\begin{minipage}{8cm}
	\centering
	\includegraphics[width=8cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_11}
	\caption{Le modèle visuel du cone est bien mis à jour dans la Scène dans SOFA après export Blender}
	\label{fig:blender_export_scene_SOFA_11}
\end{minipage}
\end{center}

\begin{center}
\begin{minipage}{14cm}
	\centering
	\includegraphics[width=8cm]{Blender_editeur_de_scenes/blender_export_scene_SOFA_12}
	\caption{Le modèle de collision de la Scène dans SOFA après export Blender utilise le même maillage que pour le modèle visuel}
	\label{fig:blender_export_scene_SOFA_12}
\end{minipage}
\end{center}



\subsubsection{Description de l'algorithme utilisé}\label{algo_export_scene_SOFA}

On parcourt la scène Blender (fonction ``exporter" de la classe ``CExport\_vers\_SOFA" ) et à chaque objet Blender rencontré :
\begin{itemize}
	\item on peuple les variables membre d'un ``solide" ( méthode ``Solide::setParametresObjet" ) 
	\item on met à jour le fichier XML ( méthode ``Solide.mettre\_fichier\_XML\_a\_jour()" )
		\begin{itemize}
			\item La mise à jour du fichier XML consiste à parcourir tous les noeuds du fichier XML à la recherche d'un noeud qui porte le nom de l'objet Blender
				\begin{itemize}
					\item Si ce noeud n'est pas trouvé, rien ne se passe
					\item Si on le trouve, tous les attributs de ses noeuds enfants sont traités par la fonction \\ ``Solide.patcherNoeud"
				\end{itemize}
		\end{itemize}
\end{itemize} 



\end{document}
